{% extends "base.html" %}

{% block title %}Αλλαγή Κωδικού - Σύστημα Διαχείρισης Αποθηκών{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-key"></i> Αλλαγή Κωδικού Πρόσβασης</h1>
        <p class="lead">Ενημερώστε τον κωδικό πρόσβασής σας</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <a href="{{ url_for('profile') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Επιστροφή στο Προφίλ
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-shield-alt"></i> Ασφάλεια Λογαριασμού</h5>
            </div>
            <div class="card-body">
                <!-- Security Guidelines -->
                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-info-circle"></i> Οδηγίες Ασφαλείας:</h6>
                    <ul class="mb-0">
                        <li>Χρησιμοποιήστε τουλάχιστον 8 χαρακτήρες</li>
                        <li>Συμπεριλάβετε κεφαλαία και πεζά γράμματα</li>
                        <li>Προσθέστε αριθμούς και ειδικούς χαρακτήρες</li>
                        <li>Αποφύγετε κοινές λέξεις ή προσωπικά στοιχεία</li>
                    </ul>
                </div>

                <form method="POST" id="passwordForm">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Τρέχων Κωδικός *</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="current_password" name="current_password" 
                                   required placeholder="Εισάγετε τον τρέχοντα κωδικό">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('current_password')">
                                <i class="fas fa-eye" id="current_password_icon"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="new_password" class="form-label">Νέος Κωδικός *</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="new_password" name="new_password" 
                                   required placeholder="Εισάγετε τον νέο κωδικό" 
                                   minlength="8" onkeyup="checkPasswordStrength()">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('new_password')">
                                <i class="fas fa-eye" id="new_password_icon"></i>
                            </button>
                        </div>
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" id="strength_bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="strength_text" class="text-muted">Εισάγετε κωδικό για έλεγχο ισχύος</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Επιβεβαίωση Νέου Κωδικού *</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                                   required placeholder="Επαναλάβετε τον νέο κωδικό" 
                                   onkeyup="checkPasswordMatch()">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirm_password')">
                                <i class="fas fa-eye" id="confirm_password_icon"></i>
                            </button>
                        </div>
                        <div id="password_match" class="mt-1"></div>
                    </div>

                    <!-- Requirements Check -->
                    <div class="alert alert-light">
                        <h6>Απαιτήσεις Κωδικού:</h6>
                        <div id="requirements">
                            <div id="length_req" class="requirement">
                                <i class="fas fa-times text-danger"></i> Τουλάχιστον 8 χαρακτήρες
                            </div>
                            <div id="uppercase_req" class="requirement">
                                <i class="fas fa-times text-danger"></i> Τουλάχιστον 1 κεφαλαίο γράμμα
                            </div>
                            <div id="lowercase_req" class="requirement">
                                <i class="fas fa-times text-danger"></i> Τουλάχιστον 1 πεζό γράμμα
                            </div>
                            <div id="number_req" class="requirement">
                                <i class="fas fa-times text-danger"></i> Τουλάχιστον 1 αριθμό
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Προσοχή:</strong> Μετά την αλλαγή του κωδικού θα χρειαστεί να συνδεθείτε ξανά.
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('profile') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times"></i> Ακύρωση
                        </a>
                        <button type="submit" class="btn btn-warning" id="submitBtn" disabled>
                            <i class="fas fa-key"></i> Αλλαγή Κωδικού
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function checkPasswordStrength() {
    const password = document.getElementById('new_password').value;
    const strengthBar = document.getElementById('strength_bar');
    const strengthText = document.getElementById('strength_text');
    
    let score = 0;
    let feedback = [];
    
    // Length check
    if (password.length >= 8) {
        score += 25;
        updateRequirement('length_req', true);
    } else {
        updateRequirement('length_req', false);
        feedback.push('Τουλάχιστον 8 χαρακτήρες');
    }
    
    // Uppercase check
    if (/[A-Z]/.test(password)) {
        score += 25;
        updateRequirement('uppercase_req', true);
    } else {
        updateRequirement('uppercase_req', false);
        feedback.push('Κεφαλαίο γράμμα');
    }
    
    // Lowercase check
    if (/[a-z]/.test(password)) {
        score += 25;
        updateRequirement('lowercase_req', true);
    } else {
        updateRequirement('lowercase_req', false);
        feedback.push('Πεζό γράμμα');
    }
    
    // Number check
    if (/[0-9]/.test(password)) {
        score += 25;
        updateRequirement('number_req', true);
    } else {
        updateRequirement('number_req', false);
        feedback.push('Αριθμό');
    }
    
    // Update strength bar
    strengthBar.style.width = score + '%';
    
    if (score < 50) {
        strengthBar.className = 'progress-bar bg-danger';
        strengthText.textContent = 'Αδύναμος κωδικός';
        strengthText.className = 'text-danger';
    } else if (score < 75) {
        strengthBar.className = 'progress-bar bg-warning';
        strengthText.textContent = 'Μέτριος κωδικός';
        strengthText.className = 'text-warning';
    } else if (score < 100) {
        strengthBar.className = 'progress-bar bg-info';
        strengthText.textContent = 'Καλός κωδικός';
        strengthText.className = 'text-info';
    } else {
        strengthBar.className = 'progress-bar bg-success';
        strengthText.textContent = 'Ισχυρός κωδικός';
        strengthText.className = 'text-success';
    }
    
    checkFormValidity();
}

function updateRequirement(reqId, met) {
    const req = document.getElementById(reqId);
    const icon = req.querySelector('i');
    
    if (met) {
        icon.className = 'fas fa-check text-success';
    } else {
        icon.className = 'fas fa-times text-danger';
    }
}

function checkPasswordMatch() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const matchDiv = document.getElementById('password_match');
    
    if (confirmPassword === '') {
        matchDiv.innerHTML = '';
        return;
    }
    
    if (newPassword === confirmPassword) {
        matchDiv.innerHTML = '<small class="text-success"><i class="fas fa-check"></i> Οι κωδικοί ταιριάζουν</small>';
    } else {
        matchDiv.innerHTML = '<small class="text-danger"><i class="fas fa-times"></i> Οι κωδικοί δεν ταιριάζουν</small>';
    }
    
    checkFormValidity();
}

function checkFormValidity() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const currentPassword = document.getElementById('current_password').value;
    const submitBtn = document.getElementById('submitBtn');
    
    // Check all requirements
    const lengthOk = newPassword.length >= 8;
    const uppercaseOk = /[A-Z]/.test(newPassword);
    const lowercaseOk = /[a-z]/.test(newPassword);
    const numberOk = /[0-9]/.test(newPassword);
    const matchOk = newPassword === confirmPassword && confirmPassword !== '';
    const currentOk = currentPassword !== '';
    
    const allValid = lengthOk && uppercaseOk && lowercaseOk && numberOk && matchOk && currentOk;
    
    submitBtn.disabled = !allValid;
    
    if (allValid) {
        submitBtn.classList.remove('btn-secondary');
        submitBtn.classList.add('btn-warning');
    } else {
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-secondary');
    }
}

// Add event listeners
document.getElementById('current_password').addEventListener('input', checkFormValidity);
document.getElementById('new_password').addEventListener('input', function() {
    checkPasswordStrength();
    checkPasswordMatch();
});
document.getElementById('confirm_password').addEventListener('input', checkPasswordMatch);

// Form submission confirmation
document.getElementById('passwordForm').addEventListener('submit', function(e) {
    if (!confirm('Είστε σίγουροι ότι θέλετε να αλλάξετε τον κωδικό πρόσβασης;')) {
        e.preventDefault();
    }
});
</script>

<style>
.requirement {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}
</style>
{% endblock %}